<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Uthaya Hollow Blocks | Stock Manager</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Roboto:wght@400;500&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --primary: #ec4899;
      /* Pink 500 */
      --primary-dark: #be185d;
      /* Pink 700 */
      --dark: #1e293b;
      /* Slate 800 */
      --darker: #0f172a;
      /* Slate 900 */
      --light: #fdf2f8;
      /* Pink 50 */
      --grey: #94a3b8;
      --danger: #ef4444;
      --success: #10b981;
      --card-shadow: 0 4px 15px rgba(236, 72, 153, 0.1);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--light);
      color: var(--dark);
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* --- Header & Nav --- */
    header {
      background-color: var(--darker);
      color: white;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 4px solid var(--primary);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .brand h1 {
      font-family: 'Rajdhani', sans-serif;
      margin: 0;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand p {
      margin: 0;
      font-size: 0.8rem;
      color: var(--grey);
    }

    nav {
      display: flex;
      gap: 5px;
    }

    nav button {
      background: transparent;
      border: 1px solid transparent;
      color: var(--grey);
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-family: 'Rajdhani', sans-serif;
      text-transform: uppercase;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    nav button:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    nav button.active {
      background: var(--primary);
      color: var(--darker);
      box-shadow: 0 0 10px rgba(243, 156, 18, 0.4);
    }

    /* --- Layout --- */
    main {
      flex: 1;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }

    .section {
      display: none;
      animation: fadeIn 0.3s ease-in-out;
    }

    .section.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    h2 {
      border-left: 5px solid var(--primary);
      padding-left: 10px;
      color: var(--darker);
      font-family: 'Rajdhani', sans-serif;
    }

    /* --- Components --- */
    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      animation: fadeIn 0.2s;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      /* Wider modal */
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .modal-checkbox-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 15px 0;
    }

    .modal-checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      border: 1px solid #eee;
      border-radius: 4px;
      cursor: pointer;
    }

    .modal-checkbox-item:hover {
      background: #f9f9f9;
      border-color: #ddd;
    }

    /* Bulk Add Area */
    .bulk-add-area {
      grid-column: 1 / -1;
      background: #F4F6F6;
      border: 1px dashed #BDC3C7;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }

    .bulk-add-area textarea {
      width: 100%;
      margin-top: 10px;
      font-family: monospace;
      padding: 8px;
      border: 1px solid #ddd;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: var(--card-shadow);
      border-top: 3px solid var(--grey);
    }

    .stat-card.highlight {
      border-top-color: var(--primary);
    }

    .stat-card h3 {
      margin: 0 0 10px;
      font-size: 0.9rem;
      color: var(--grey);
      text-transform: uppercase;
    }

    /* Low Stock Alert Styles */
    .alert-banner {
      background: #FADBD8;
      color: #721C24;
      border: 1px solid #F5C6CB;
      padding: 10px;
      margin-bottom: 20px;
      border-radius: 4px;
      display: none;
      /* Hidden by default */
    }

    .alert-banner h3 {
      margin: 0 0 5px 0;
      font-size: 1rem;
    }

    .alert-list {
      margin: 0;
      padding-left: 20px;
      font-size: 0.9rem;
    }

    .stat-card .value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--darker);
      font-family: 'Rajdhani', sans-serif;
    }

    /* Forms */
    .card {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: var(--card-shadow);
      margin-bottom: 20px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      align-items: end;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--dark);
    }

    input,
    select,
    textarea {
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
      font-family: 'Roboto', sans-serif;
      transition: border-color 0.2s;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--primary);
      outline: none;
    }

    button.btn-primary {
      background-color: var(--dark);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      text-transform: uppercase;
      font-family: 'Rajdhani', sans-serif;
      transition: background 0.2s;
    }

    button.btn-primary:hover {
      background-color: var(--primary);
      color: var(--darker);
    }

    /* Tables */
    .table-container {
      overflow-x: auto;
      background: white;
      border-radius: 8px;
      box-shadow: var(--card-shadow);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }

    th,
    td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background-color: var(--darker);
      color: white;
      font-weight: 500;
      font-family: 'Rajdhani', sans-serif;
      letter-spacing: 0.5px;
    }

    tr:hover {
      background-color: #f9f9f9;
    }

    .badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-buy {
      background: #E8F8F5;
      color: var(--success);
    }

    .badge-sell {
      background: #FDEDEC;
      color: var(--danger);
    }

    /* Dealer List */
    .dealer-list {
      display: grid;
      gap: 15px;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    }

    .dealer-card {
      background: white;
      border-left: 4px solid var(--primary);
      padding: 15px;
      border-radius: 4px;
      box-shadow: var(--card-shadow);
    }

    .dealer-card h4 {
      margin: 0 0 5px;
      color: var(--darker);
    }

    .dealer-card p {
      margin: 0;
      color: var(--grey);
      font-size: 0.9rem;
    }

    footer {
      text-align: center;
      padding: 20px;
      color: var(--grey);
      font-size: 0.8rem;
      margin-top: auto;
    }

    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .filters input {
      padding: 8px;
      width: 200px;
    }

    #newMaterialGroup {
      display: none;
      margin-top: 10px;
      background: #FFF3CD;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #FFEEBA;
    }

    /* --- Input Groups (Inline Buttons) --- */
    .input-group {
      display: flex;
      gap: 10px;
    }

    .input-group select {
      flex: 1;
      min-width: 0;
      /* Fix flex issue */
    }

    .btn-inline-del {
      min-width: 50px;
      flex-shrink: 0;
      padding: 0;
      background: #fee;
      border: 1px solid #fcc;
      color: red;
      border-radius: 4px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
    }

    .btn-inline-del:hover {
      background: #fdd;
    }

    /* --- Data Management Section (Transparent) --- */
    .data-management {
      margin-top: 50px;
      padding: 20px;
      border-top: 2px dashed #ddd;
      opacity: 0.4;
      transition: opacity 0.3s;
      font-family: 'Courier New', monospace;
      /* Monospace for "technical" feel */
    }

    .data-management:hover {
      opacity: 1;
    }

    .data-management h3 {
      font-size: 1rem;
      color: var(--grey);
      text-transform: uppercase;
      margin-bottom: 15px;
    }

    .dm-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }

    /* Toggle Switch for Type */
    .type-toggle {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .type-option {
      flex: 1;
      text-align: center;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      color: #aaa;
    }

    .type-option.active.buy {
      background-color: #E8F8F5;
      border-color: var(--success);
      color: var(--success);
    }

    .type-option.active.sell {
      background-color: #FDEDEC;
      border-color: var(--danger);
      color: var(--danger);
    }

    .dm-card {
      background: #fdfdfd;
      border: 1px solid #eee;
      padding: 10px;
      border-radius: 4px;
    }

    .dm-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
      margin-bottom: 5px;
      color: var(--dark);
    }

    .dm-sizes {
      padding-left: 10px;
      border-left: 2px solid #eee;
      margin-top: 5px;
    }

    .dm-size-item {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      padding: 2px 0;
      color: var(--grey);
    }

    .btn-icon {
      border: none;
      background: none;
      cursor: pointer;
      font-size: 1rem;
      opacity: 0.6;
      transition: opacity 0.2s;
    }

    .btn-icon:hover {
      opacity: 1;
      transform: scale(1.1);
    }

    /* Login System */
    #login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(44, 62, 80, 0.98);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px);
    }

    .login-box {
      background: white;
      padding: 40px;
      border-radius: 12px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
      text-align: center;
      border-top: 5px solid var(--primary);
    }

    .login-box h2 {
      margin-top: 0;
      color: var(--darker);
      border: none;
      padding: 0;
      margin-bottom: 20px;
    }

    #signup-view,
    #forgot-view {
      display: none;
    }

    .login-input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    .login-input:focus {
      border-color: var(--primary);
      outline: none;
    }

    .btn-login {
      width: 100%;
      padding: 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      margin-top: 15px;
      transition: background 0.3s;
    }

    .btn-login:hover {
      background: var(--primary-dark);
    }

    .login-error {
      color: var(--danger);
      margin-top: 10px;
      font-weight: bold;
      display: none;
    }

    .login-box a {
      color: var(--primary);
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .login-box a:hover {
      text-decoration: underline;
    }

    /* Role Based Hiding */
    body.no-edit button[title="Edit"] {
      display: none !important;
    }

    body.no-delete button[title="Delete"],
    body.no-delete .btn-inline-del {
      display: none !important;
    }

    /* Ensure Action Buttons in User Modal are VISIBLE to Master */
    /* Master does NOT have .no-edit class, so this is fine. 
       Issue might be specificity or btn-inline-del being used elsewhere. 
       Let's ensure .btn-inline-del is visible by default. */

    body.no-entry .nav-entry-btn {
      display: none !important;
    }
  </style>
</head>

<body>

  <header>
    <div class="brand">
      <h1>üèóÔ∏è Uthaya Hollow Blocks</h1>
      <p>Inventory & Stock Manager</p>
    </div>
    <nav>
      <button onclick="navigate('home')" id="nav-home" class="active">üè† Home</button>
      <button onclick="navigate('entry')" id="nav-entry">‚ûï Entry</button>
      <button onclick="navigate('records')" id="nav-records">ÔøΩ Records</button>
      <button onclick="navigate('dealers')" id="nav-dealers">ü§ù Dealers</button>
    </nav>
  </header>

  <main>
    <!-- HOME / DASHBOARD -->
    <section id="home" class="active section">
      <h2>üìä Stock Dashboard</h2>

      <div id="lowStockAlert" class="alert-banner">
        <h3>‚ö†Ô∏è Low Stock Alert (Close to end)</h3>
        <ul id="lowStockList" class="alert-list"></ul>
      </div>

      <div class="stat-container">
        <div class="stat-card highlight">
          <h3>üì¶ Material Stock In</h3>
          <div class="value" id="stat-in">0</div>
          <small>Raw Materials Received</small>
        </div>
        <div class="stat-card highlight">
          <h3>üß± Products Sold</h3>
          <div class="value" id="stat-out">0</div>
          <small>Finished Goods Dispatched</small>
        </div>
        <div class="stat-card">
          <h3>üìù Total Records</h3>
          <div class="value" id="stat-total">0</div>
          <small>All Transactions</small>
        </div>
      </div>

      <div class="card">
        <h3>üïí Recent Activity</h3>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Material</th>
                <th>Qty</th>
                <th>Trader</th>
              </tr>
            </thead>
            <tbody id="recent-table-body">
              <!-- Populated by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ENTRY SECTION (Form Only) -->
    <section id="entry" class="section">
      <h2>‚ûï New Transaction</h2>
      <div class="card">
        <form id="tradeForm">
          <!-- Transaction Type Toggle -->
          <div class="type-toggle">
            <div class="type-option" id="opt-buy" onclick="setTxType('buy')">üü¢ Stock In (Buy)</div>
            <div class="type-option active sell" id="opt-sell" onclick="setTxType('sell')">üî¥ Stock Out (Sell)</div>
          </div>
          <input type="hidden" id="t-type" value="sell">
          <input type="hidden" id="t-id"> <!-- For Editing -->

          <div class="form-grid">
            <!-- Date -->
            <div class="form-group">
              <label>Date</label>
              <input type="date" id="t-date" required>
            </div>

            <!-- Trader -->
            <div class="form-group">
              <label>Buyer Name</label>
              <input type="text" id="t-name" list="traderList" placeholder="Search or type name..." required
                oninput="fillContact()">
              <datalist id="traderList"></datalist>
            </div>

            <div class="form-group">
              <label>Contact</label>
              <input type="text" id="t-contact" placeholder="Phone Number">
            </div>

            <!-- Product -->
            <div class="form-group">
              <label>Product</label>
              <div class="input-group">
                <select id="t-product" required onchange="handleProductChange()">
                  <option value="">Select Product...</option>
                </select>
                <button type="button" id="btn-del-prod" class="btn-inline-del" onclick="deleteCurrentProduct()"
                  title="Delete this product">üóëÔ∏è</button>
              </div>
            </div>

            <!-- Size -->
            <div class="form-group">
              <label>Size</label>
              <div class="input-group">
                <select id="t-size" required onchange="handleSizeChange()">
                  <option value="">Select Product First...</option>
                </select>
                <button type="button" id="btn-del-size" class="btn-inline-del" onclick="deleteCurrentSize()"
                  title="Delete this size">üóëÔ∏è</button>
              </div>
            </div>

            <!-- Quantity -->
            <div class="form-group">
              <label>Quantity</label>
              <input type="number" id="t-qty" placeholder="Units" required>
            </div>
          </div>

          <!-- Dynamic Input for "New Product" -->
          <div id="newProductGroup"
            style="display:none; margin-top:10px; background:#e8f4fd; padding:10px; border-radius:4px;">
            <label style="color:#2980b9;">‚ú® New Product Name:</label>
            <input type="text" id="t-custom-product" placeholder="e.g. Paver Block">
          </div>

          <!-- Dynamic Input for "New Size" -->
          <div id="newSizeGroup"
            style="display:none; margin-top:10px; background:#e8f4fd; padding:10px; border-radius:4px;">
            <label style="color:#2980b9;">üìè New Size:</label>
            <input type="text" id="t-custom-size" placeholder="e.g. 10 x 10">
          </div>

          <div class="form-group" style="margin-top:15px;">
            <label>Notes</label>
            <textarea id="t-notes" rows="1" placeholder="Optional details..."></textarea>
          </div>

          <div style="margin-top: 20px; text-align: right; display:flex; justify-content:flex-end; gap:10px;">
            <button type="button" id="btn-cancel"
              style="display:none; background:#ccc; border:none; padding:12px 20px; border-radius:4px; cursor:pointer;"
              onclick="cancelEdit()">‚ùå Cancel</button>
            <button type="submit" class="btn-primary" id="btn-submit">üì§ Record Sale</button>
          </div>
        </form>
      </div>
    </section>

    <!-- RECORDS SECTION (Table + Catalog) -->
    <section id="records" class="section">
      <h2>üìã Sales & Stock Records</h2>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Buyer</th>
              <th>Contact</th>
              <th>Type</th>
              <th>Product</th>
              <th>Size</th>
              <th>Qty</th>
              <th>Notes</th>
              <th>Action</th>
            </tr>
            <!-- Filter Row -->
            <tr style="background:#f1f1f1;">
              <td style="padding:5px;"><input type="date" id="f-date-start" onchange="renderTable()"
                  style="width:100%; font-size:0.8rem; padding:4px;"></td>
              <td style="padding:5px;"><input type="text" id="f-buyer" onkeyup="renderTable()" placeholder="Filter..."
                  style="width:100%; font-size:0.8rem; padding:4px;"></td>
              <td style="padding:5px;"></td>
              <td style="padding:5px;">
                <select id="f-type" onchange="renderTable()" style="width:100%; font-size:0.8rem; padding:4px;">
                  <option value="all">All</option>
                  <option value="buy">In</option>
                  <option value="sell">Out</option>
                </select>
              </td>
              <td style="padding:5px;"><input type="text" id="f-product" onkeyup="renderTable()"
                  placeholder="Product..." style="width:100%; font-size:0.8rem; padding:4px;"></td>
              <td style="padding:5px;"><input type="text" id="f-size" onkeyup="renderTable()" placeholder="Size..."
                  style="width:100%; font-size:0.8rem; padding:4px;"></td>
              <td colspan="3" style="text-align:right; padding:5px;">
                <button onclick="exportReport()"
                  style="background:#27AE60; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">üì•
                  Export View</button>
              </td>
            </tr>
          </thead>
          <tbody id="full-table-body">
            <!-- Populated by JS -->
          </tbody>
        </table>
      </div>

      <!-- DATA MANAGEMENT (Transparent Section) -->
      <div class="data-management">
        <h3>üõ†Ô∏è Catalog Manager (Edit/Delete Products)</h3>
        <p style="font-size:0.8rem; margin-bottom:15px;">Manage your products and sizes here. Hover to see details.</p>
        <div id="catalog-manager" class="dm-grid">
          <!-- Populated by JS -->
        </div>
      </div>
    </section>

    <!-- DEALERS SECTION -->
    <section id="dealers" class="section">
      <h2>ü§ù Dealer Directory</h2>
      <div class="filters">
        <input type="text" id="dealer-search" placeholder="üîç Find dealer..." onkeyup="renderDealers()">
      </div>
      <div id="dealer-grid" class="dealer-list">
        <!-- Dealer cards go here -->
      </div>
    </section>
  </main>

  <footer>
    <p>üìç Singampunari, Tamil Nadu | üìû +91 96263 1025 | üë§ Rajee</p>
  </footer>

  <script>
    // --- AUTHENTICATION SYSTEM ---
    const auth = {
      master: { user: 'Developer', pass: 'Sanmugapriyan' },
      users: JSON.parse(localStorage.getItem('UHD_USERS')) || [],
      requests: JSON.parse(localStorage.getItem('UHD_PASS_REQUESTS')) || [], // [ {user, time} ]
      signupRequests: JSON.parse(localStorage.getItem('UHD_SIGNUP_REQUESTS')) || [], // [ {user, pass, time} ]
      currentUser: null,

      init() {
        // Force Login on Reload
        this.renderUserList();

        // Allow Enter key on login
        const passField = document.getElementById('login-pass');
        if (passField) {
          passField.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') auth.login();
          });
        }
      },

      toggleResetView(show) {
        document.getElementById('login-view').style.display = show ? 'none' : 'block';
        document.getElementById('reset-view').style.display = show ? 'block' : 'none';
        document.getElementById('login-error').style.display = 'none';
      },

      requestReset() {
        const u = document.getElementById('reset-user').value.trim();
        if (!u) return alert("Please enter your username.");

        // Check if user exists (case-insensitive)
        const exists = this.users.find(usr => usr.user.toLowerCase() === u.toLowerCase());
        if (!exists && u.toLowerCase() !== this.master.user.toLowerCase()) {
          return alert("‚ùå User not found!");
        }

        // Check if already requested
        if (this.requests.find(r => r.user.toLowerCase() === u.toLowerCase())) {
          return alert("‚ö†Ô∏è Request already sent! Ask Master to check.");
        }

        this.requests.push({ user: u, time: new Date().toLocaleString() });
        localStorage.setItem('UHD_PASS_REQUESTS', JSON.stringify(this.requests));

        alert("‚úÖ Request Sent! Ask the Master to approve it.");
        this.toggleResetView(false);
      },

      login() {
        const uInput = document.getElementById('login-user').value.trim();
        const pInput = document.getElementById('login-pass').value.trim();
        const err = document.getElementById('login-error');

        if (!uInput || !pInput) return;

        // Normalize for checking
        const u = uInput.toLowerCase();
        const p = pInput; // Passwords are case sensitive usually, but for simplicity here we keep strict

        // 1. Check Master
        if (u === this.master.user.toLowerCase() && p === this.master.pass) {
          this.completeLogin(this.master.user, 'Master'); // Use canonical name
          return;
        }

        // 2. Check Other Users (Case Insensitive Username)
        // Fixed: Added safety check (usr && usr.user) to prevent crash if data is corrupted
        const found = this.users.find(usr => usr && usr.user && usr.user.toLowerCase() === u && usr.pass === p);

        if (found) {
          this.completeLogin(found.user, found.role || 'Manager');
          return;
        }

        // Debug help: Check if user exists but password failed
        const exists = this.users.find(usr => usr && usr.user && usr.user.toLowerCase() === u);
        if (exists && exists.pass !== p) {
          console.warn("Login Failed: Password Incorrect for " + u);
        }

        // Fail
        err.style.display = 'block';
        err.textContent = 'üö´ Access Denied: Invalid Credentials';
        this.shakeLogin();
      },

      completeLogin(user, role) {
        this.currentUser = { user, role };
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('login-error').style.display = 'none';

        this.applyPermissions(role);

        // Notify Master of Requests
        const totalReqs = this.requests.length + (this.signupRequests ? this.signupRequests.length : 0);
        if (role === 'Master' && totalReqs > 0) {
          setTimeout(() => {
            alert(`üîî You have pending requests! Check the Users menu.`);
            const btn = document.getElementById('nav-users');
            if (btn) btn.innerHTML = 'üîê Users <span style="color:red">‚óè</span>';
          }, 500);
        }
      },

      toggleSignupView(show) {
        document.getElementById('login-view').style.display = show ? 'none' : 'block';
        document.getElementById('signup-view').style.display = show ? 'block' : 'none';
        document.getElementById('reset-view').style.display = 'none';
        document.getElementById('login-error').style.display = 'none';
      },

      handleSignup() {
        const u = document.getElementById('signup-user').value.trim();
        const p = document.getElementById('signup-pass').value.trim();

        if (!u || !p) return alert("Enter username and password");
        if (this.users.find(usr => usr.user.toLowerCase() === u.toLowerCase()) || u.toLowerCase() === this.master.user.toLowerCase()) {
          return alert("Username already exists");
        }

        if (!this.signupRequests) this.signupRequests = [];
        if (this.signupRequests.find(r => r.user.toLowerCase() === u.toLowerCase())) {
          return alert("Request already pending");
        }

        this.signupRequests.push({ user: u, pass: p, time: new Date().toLocaleString() });
        localStorage.setItem('UHD_SIGNUP_REQUESTS', JSON.stringify(this.signupRequests));

        alert("‚úÖ Request Sent! Ask Master for approval.");
        this.toggleSignupView(false);
      },

      approveSignup(reqUser) {
        const req = this.signupRequests.find(r => r.user === reqUser);
        if (!req) return;

        this.openUserProfile(req.user, req.pass, true);
      },

      openUserProfile(uName, pass = '', isNew = false) {
        const user = this.users.find(u => u.user === uName);
        const isSignup = !user && isNew;

        document.getElementById('profile-title').innerText = isSignup ? `Approve user: ${uName}` : `Edit Profile: ${uName}`;
        document.getElementById('prof-user').value = uName;
        document.getElementById('prof-pass').value = user ? user.pass : pass;
        document.getElementById('prof-role').value = user ? (user.role || 'Worker') : 'Worker';

        const perms = (user && user.permissions) ? user.permissions : { add: true, edit: false, delete: false, reports: false };
        document.getElementById('p-add').checked = perms.add;
        document.getElementById('p-edit').checked = perms.edit;
        document.getElementById('p-delete').checked = perms.delete;
        document.getElementById('p-reports').checked = perms.reports;

        document.getElementById('userProfileModal').style.display = 'flex';
        if (!isSignup) document.getElementById('userModal').style.display = 'none';
      },

      applyRoleDefaults() {
        const role = document.getElementById('prof-role').value;
        const defaults = {
          'Owner': { add: true, edit: true, delete: true, reports: true },
          'Worker': { add: true, edit: false, delete: false, reports: false },
          'Guest': { add: false, edit: false, delete: false, reports: true }
        };
        const perms = defaults[role] || defaults['Guest'];
        document.getElementById('p-add').checked = perms.add;
        document.getElementById('p-edit').checked = perms.edit;
        document.getElementById('p-delete').checked = perms.delete;
        document.getElementById('p-reports').checked = perms.reports;
        const pLimits = document.getElementById('p-limits');
        if (pLimits) pLimits.checked = perms.reports || (role === 'Owner');
      },

      saveUserProfile() {
        const u = document.getElementById('prof-user').value;
        const p = document.getElementById('prof-pass').value;
        const r = document.getElementById('prof-role').value;
        const perms = {
          add: document.getElementById('p-add').checked,
          edit: document.getElementById('p-edit').checked,
          delete: document.getElementById('p-delete').checked,
          reports: document.getElementById('p-reports').checked
        };

        let user = this.users.find(usr => usr.user === u);
        if (user) {
          user.pass = p;
          user.role = r;
          user.permissions = perms;
        } else {
          this.users.push({ user: u, pass: p, role: r, permissions: perms });
          this.signupRequests = this.signupRequests.filter(req => req.user !== u);
          localStorage.setItem('UHD_SIGNUP_REQUESTS', JSON.stringify(this.signupRequests));
        }

        localStorage.setItem('UHD_USERS', JSON.stringify(this.users));
        this.renderUserList();
        this.applyPermissions(this.currentUser.role);

        document.getElementById('userProfileModal').style.display = 'none';
        this.openUserModal(); // Return to previous management list

        alert("‚úÖ Profile Updated Successfully");
      },

      denySignup(reqUser, confirmReq = true) {
        if (confirmReq && !confirm("Deny this signup?")) return;
        this.signupRequests = this.signupRequests.filter(r => r.user !== reqUser);
        localStorage.setItem('UHD_SIGNUP_REQUESTS', JSON.stringify(this.signupRequests));
        this.renderUserList();
      },

      applyPermissions(role) {
        const isMaster = role === 'Master';
        const perms = isMaster ?
          { add: true, edit: true, delete: true, reports: true } :
          (this.currentUser.permissions || { add: true, edit: false, delete: false, reports: false });

        this.currentUser.permissions = perms;

        // Toggle Master Controls
        if (isMaster) this.showMasterControls();

        // Enforce Navigation Visibility
        this.toggleElement('nav-entry', perms.add || isMaster);
        this.toggleElement('nav-dealers', perms.reports || isMaster);
        this.toggleElement('catalog-manager', isMaster);

        // Reports View
        const repBtn = document.querySelector('[onclick="navigate(\'reports\')"]');
        if (repBtn) repBtn.style.display = (perms.reports || isMaster) ? 'block' : 'none';

        // Action permissions via body classes
        if (isMaster || perms.edit) document.body.classList.remove('no-edit');
        else document.body.classList.add('no-edit');

        if (isMaster || perms.delete) document.body.classList.remove('no-delete');
        else document.body.classList.add('no-delete');

        refreshAll();
        if (!perms.add && !isMaster) navigate('home');
      },

      toggleElement(id, show) {
        const el = document.getElementById(id);
        if (el) el.style.display = show ? '' : 'none';
      },

      shakeLogin() {
        const box = document.querySelector('.login-box');
        if (!box) return; // safety
        box.style.transform = 'translateX(10px)';
        setTimeout(() => box.style.transform = 'translateX(-10px)', 100);
        setTimeout(() => box.style.transform = 'translateX(0)', 200);
      },

      // User Management (Master Only)
      openUserModal() {
        if (this.currentUser?.role !== 'Master') return;
        document.getElementById('userModal').style.display = 'flex';
        this.renderUserList();
      },

      closeUserModal() {
        document.getElementById('userModal').style.display = 'none';
      },

      addUser() {
        if (this.currentUser?.role !== 'Master') return;
        const u = document.getElementById('new-u-name').value.trim();
        const p = document.getElementById('new-u-pass').value.trim();
        const r = document.getElementById('new-u-role').value;

        if (!u || !p) return alert("Enter username and password");
        if (u.toLowerCase() === this.master.user.toLowerCase()) return alert("Cannot duplicate Master");
        if (this.users.find(usr => usr.user.toLowerCase() === u.toLowerCase())) return alert("User already exists");

        this.users.push({ user: u, pass: p, role: r });
        localStorage.setItem('UHD_USERS', JSON.stringify(this.users));

        document.getElementById('new-u-name').value = '';
        document.getElementById('new-u-pass').value = '';
        this.renderUserList();
        alert(`‚úÖ ${r} Added`);
      },

      removeUser(uName) {
        if (this.currentUser?.role !== 'Master') return;
        if (!confirm(`Remove user "${uName}"?`)) return;

        this.users = this.users.filter(usr => usr.user !== uName);
        localStorage.setItem('UHD_USERS', JSON.stringify(this.users));
        this.renderUserList();
      },

      grantReset(reqUser) {
        const newPass = Math.floor(1000 + Math.random() * 9000).toString(); // 4 digit pin

        // Update user password
        const userIdx = this.users.findIndex(u => u.user === reqUser);
        if (userIdx !== -1) {
          this.users[userIdx].pass = newPass;
          localStorage.setItem('UHD_USERS', JSON.stringify(this.users));
        }

        // Remove Request
        this.requests = this.requests.filter(r => r.user !== reqUser);
        localStorage.setItem('UHD_PASS_REQUESTS', JSON.stringify(this.requests));

        this.renderUserList();
        alert(`‚úÖ Password Reset!\n\nUser: ${reqUser}\nNew Password: ${newPass}\n\nPlease tell them immediately.`);
      },

      denyReset(reqUser) {
        if (!confirm("Deny this request?")) return;
        this.requests = this.requests.filter(r => r.user !== reqUser);
        localStorage.setItem('UHD_PASS_REQUESTS', JSON.stringify(this.requests));
        this.renderUserList();
      },

      renderUserList() {
        const tbody = document.getElementById('user-list-body');
        if (!tbody) return;

        let html = '';

        // 1. Password Reset Requests
        if (this.requests.length > 0) {
          html += `<tr><td colspan="3" style="background:#fee; font-weight:bold; color:red; text-align:center;">üîî Password Reset Requests</td></tr>`;
          this.requests.forEach(req => {
            html += `
                    <tr style="background:#fff5f5;">
                        <td>${req.user} <br><small style="color:#666">${req.time}</small></td>
                        <td><i>Requested Reset</i></td>
                        <td>
                            <button onclick="auth.grantReset('${req.user}')" class="btn-primary" style="padding:2px 8px; font-size:0.8rem;">Grant</button>
                            <button onclick="auth.denyReset('${req.user}')" style="color:red; border:none; background:none; cursor:pointer;">‚ùå</button>
                        </td>
                    </tr>
                `;
          });
        }

        // 2. Signup Requests
        if (this.signupRequests && this.signupRequests.length > 0) {
          html += `<tr><td colspan="3" style="background:#fdf2f8; font-weight:bold; color:var(--primary); text-align:center;">‚ú® Signup Requests</td></tr>`;
          this.signupRequests.forEach(req => {
            html += `
                    <tr style="background:#fff5f7;">
                        <td>${req.user} <br><small style="color:#666">${req.time}</small></td>
                        <td>Pass: <span style="background:#eee; padding:2px 4px; border-radius:4px;">${req.pass}</span></td>
                        <td>
                            <button onclick="auth.approveSignup('${req.user}')" class="btn-primary" style="padding:2px 8px; font-size:0.8rem; background:var(--primary);">Approve</button>
                            <button onclick="auth.denySignup('${req.user}')" style="color:red; border:none; background:none; cursor:pointer;">‚ùå</button>
                        </td>
                    </tr>
                `;
          });
        }

        if (this.requests.length > 0 || (this.signupRequests && this.signupRequests.length > 0)) {
          html += `<tr><td colspan="3" style="border-bottom:2px solid #ddd;"></td></tr>`;
        }

        // 3. User List
        html += `
            <tr style="background:#FFF3CD">
                <td>${this.master.user}</td>
                <td><b>MASTER</b></td>
                <td>-</td>
            </tr>
        `;

        this.users.forEach(usr => {
          html += `
                    <tr onclick="auth.openUserProfile('${usr.user}')" style="cursor:pointer;">
                        <td>${usr.user} <br><small style="background:#f1f5f9; padding:2px 4px;">Pass: ${usr.pass}</small></td>
                        <td>${usr.role || 'Worker'}</td>
                        <td>
                            <button onclick="event.stopPropagation(); auth.removeUser('${usr.user}')" 
                                    class="btn-inline-del" 
                                    style="display:inline-block; color:red; border:1px solid red; background:#fee; padding:2px 6px; cursor:pointer;">
                                Remove
                            </button>
                        </td>
                    </tr>
                `;
        });
        tbody.innerHTML = html;

        // Check badge update
        const btn = document.getElementById('nav-users');
        if (btn) {
          const total = this.requests.length + (this.signupRequests ? this.signupRequests.length : 0);
          if (total > 0) btn.innerHTML = 'üîê Users <span style="color:red">‚óè</span>';
          else btn.innerHTML = 'üîê Users';
        }
      },

      showMasterControls() {
        // Add User Mgmt Button to Nav if not exists
        if (!document.getElementById('nav-users')) {
          const nav = document.querySelector('nav');
          const btn = document.createElement('button');
          btn.id = 'nav-users';
          btn.innerHTML = this.requests.length > 0 ? 'üîê Users <span style="color:red">‚óè</span>' : 'üîê Users';
          btn.onclick = () => auth.openUserModal();
          btn.style.color = 'var(--grey)';
          btn.style.borderColor = 'var(--primary)';
          // Insert before Dealers or at end
          nav.appendChild(btn);
        }
      }
    };

    // Init Auth on Load
    window.addEventListener('load', () => auth.init());


    // --- State Management ---
    const DB_KEYS = {
      TX: 'uhb_transactions',
      TX: 'udt_tx_v2',
      TRADERS: 'udt_traders_v2',
      CATALOG: 'udt_catalog_v2'
    };

    // Updated Catalog based on user request
    const DEFAULT_CATALOG = {
      'Block': ['6 7 15', '6 7 12', '4 7 12'],
      'Sewage Ring': ['2f', '3f', '3.5f', '4f'],
      'Lid of sewage ring': ['2f', '3f', '3.5f', '4f'],
      'Pot': ['2f'],
      'Compound Post + Slab': ['6f', '8f'],
      'Window': ['1*1', '2*1', '1.5*1.5', '2*2'],
      'Hen plate': [],
      'Exhaust cover': []
    };

    let state = {
      transactions: JSON.parse(localStorage.getItem(DB_KEYS.TX)) || [],
      traders: JSON.parse(localStorage.getItem(DB_KEYS.TRADERS)) || {},
      catalog: JSON.parse(localStorage.getItem(DB_KEYS.CATALOG)) || DEFAULT_CATALOG,
      auditLog: JSON.parse(localStorage.getItem('UHD_AUDIT_LOG')) || [] // New Audit Log
    };

    // --- Init ---
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('t-date').valueAsDate = new Date();
      updateProducts();
      updateTraderDataList();
      refreshAll();
    });

    function saveData() {
      localStorage.setItem(DB_KEYS.TX, JSON.stringify(state.transactions));
      localStorage.setItem(DB_KEYS.TRADERS, JSON.stringify(state.traders));
      localStorage.setItem(DB_KEYS.CATALOG, JSON.stringify(state.catalog));
      localStorage.setItem('UHD_AUDIT_LOG', JSON.stringify(state.auditLog));
    }

    function logAudit(action, details) {
      state.auditLog.push({
        timestamp: new Date().toISOString(),
        action: action,
        details: details,
        userTime: new Date().toLocaleString()
      });
      saveData();
    }

    function refreshAll() {
      renderDashboard();
      renderTable();
      renderDealers();
      updateTraderDataList();
    }

    // --- Navigation ---
    window.navigate = (pageId) => {
      document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));

      document.getElementById(pageId).classList.add('active');
      document.getElementById(`nav-${pageId}`).classList.add('active');
    };

    window.setTxType = (type) => {
      document.getElementById('t-type').value = type;

      // Visual Update
      document.getElementById('opt-buy').className = `type-option ${type === 'buy' ? 'active buy' : ''}`;
      document.getElementById('opt-sell').className = `type-option ${type === 'sell' ? 'active sell' : ''}`;

      // Update Button Text
      const submitBtn = document.getElementById('btn-submit');
      if (document.getElementById('t-id').value) {
        submitBtn.textContent = type === 'buy' ? 'üíæ Update Stock In' : 'üíæ Update Sale';
      } else {
        submitBtn.textContent = type === 'buy' ? 'üì• Add Stock' : 'üì§ Record Sale';
      }
    };

    // --- Core Logic ---

    function updateProducts() {
      const select = document.getElementById('t-product');
      select.innerHTML = '<option value="">Select Product...</option>';

      Object.keys(state.catalog).forEach(prod => {
        select.add(new Option(prod, prod));
      });

      select.add(new Option("‚ûï Add New Product...", "NEW_PROD"));
      handleProductChange();
    }

    function handleProductChange() {
      const prodSelect = document.getElementById('t-product');
      const val = prodSelect.value;
      const customGroup = document.getElementById('newProductGroup');
      const customInput = document.getElementById('t-custom-product');
      const delBtn = document.getElementById('btn-del-prod');

      // Show/Hide Delete Button
      if (val && val !== 'NEW_PROD') {
        delBtn.style.display = 'flex';
      } else {
        delBtn.style.display = 'none';
      }

      // Toggle New Product Input
      if (val === 'NEW_PROD') {
        customGroup.style.display = 'block';
        customInput.setAttribute('required', 'true');
        // Clear size dropdown when adding new product
        updateSizes(null);
      } else {
        customGroup.style.display = 'none';
        customInput.removeAttribute('required');
        customInput.value = '';
        updateSizes(val);
      }
    }

    function updateSizes(productName) {
      const sizeSelect = document.getElementById('t-size');
      sizeSelect.innerHTML = '<option value="">Select Size...</option>';

      if (!productName) {
        sizeSelect.add(new Option("‚ûï Add New Size...", "NEW_SIZE")); // Allow adding size for new product
        handleSizeChange();
        return;
      }

      const sizes = state.catalog[productName] || [];
      sizes.forEach(s => sizeSelect.add(new Option(s, s)));

      sizeSelect.add(new Option("‚ûï Add New Size...", "NEW_SIZE"));
      handleSizeChange();
    }

    function handleSizeChange() {
      const sizeSelect = document.getElementById('t-size');
      const val = sizeSelect.value;
      const customGroup = document.getElementById('newSizeGroup');
      const customInput = document.getElementById('t-custom-size');
      const delBtn = document.getElementById('btn-del-size');

      // Show/Hide Delete Button
      if (val && val !== 'NEW_SIZE') {
        delBtn.style.display = 'flex';
      } else {
        delBtn.style.display = 'none';
      }

      if (val === 'NEW_SIZE') {
        customGroup.style.display = 'block';
        customInput.setAttribute('required', 'true');
      } else {
        customGroup.style.display = 'none';
        customInput.removeAttribute('required');
        customInput.value = '';
      }
    }

    function deleteCurrentProduct() {
      const prod = document.getElementById('t-product').value;
      if (prod && confirm(`Delete product "${prod}" and all its sizes permanently?`)) {
        delete state.catalog[prod];
        saveData();
        updateProducts(); // Will reset selection
        refreshAll(); // Update bottom manager view too
      }
    }

    function deleteCurrentSize() {
      const prod = document.getElementById('t-product').value;
      const size = document.getElementById('t-size').value;
      if (prod && size && confirm(`Delete size "${size}" from "${prod}"?`)) {
        state.catalog[prod] = state.catalog[prod].filter(s => s !== size);
        saveData();
        updateSizes(prod); // Refresh sizes to remove deleted one
        refreshAll();
      }
    }

    function fillContact() {
      const name = document.getElementById('t-name').value.trim();
      if (state.traders[name]) {
        document.getElementById('t-contact').value = state.traders[name];
      }
    }

    function updateTraderDataList() {
      const list = document.getElementById('traderList');
      list.innerHTML = '';
      Object.keys(state.traders).forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        list.appendChild(opt);
      });
    }

    // --- Form Submission ---
    document.getElementById('tradeForm').addEventListener('submit', (e) => {
      e.preventDefault();

      let product = document.getElementById('t-product').value;
      let size = document.getElementById('t-size').value;
      const newProdName = document.getElementById('t-custom-product').value.trim();
      const newSizeName = document.getElementById('t-custom-size').value.trim();
      const name = document.getElementById('t-name').value.trim();
      const contact = document.getElementById('t-contact').value.trim();
      const id = document.getElementById('t-id').value; // Check for id

      // Handle New Product
      if (product === 'NEW_PROD') {
        if (!newProdName) return alert("Please enter the new product name");
        product = newProdName;
        // Init in catalog if not exists
        if (!state.catalog[product]) {
          state.catalog[product] = [];
        }
      }

      // Handle New Size
      if (size === 'NEW_SIZE') {
        if (!newSizeName) return alert("Please enter the new size");
        size = newSizeName;
        // Add to catalog for this product
        if (!state.catalog[product].includes(size)) {
          state.catalog[product].push(size);
        }
      }

      // Save Trader
      if (contact) state.traders[name] = contact;

      const type = document.getElementById('t-type').value;

      const txnData = {
        id: id ? parseInt(id) : Date.now(),
        date: document.getElementById('t-date').value,
        type: type,
        name,
        contact,
        product,
        size,
        qty: parseInt(document.getElementById('t-qty').value),
        notes: document.getElementById('t-notes').value
      };

      if (id) {
        // Update existing
        const index = state.transactions.findIndex(t => t.id === parseInt(id));
        if (index !== -1) {
          const oldTx = state.transactions[index];
          logAudit('EDIT', { old: oldTx, new: txnData }); // Log the change
          state.transactions[index] = txnData;
          alert('Transaction Updated! üîÑ');
        }
      } else {
        // Create new
        state.transactions.unshift(txnData);
        logAudit('CREATE', txnData); // Log creation
        alert(type === 'buy' ? 'Stock Added! üì•' : 'Sale Recorded! üì§');
      }

      saveData();
      cancelEdit(); // Helper to reset form
      refreshAll();
    });

    function cancelEdit() {
      document.getElementById('t-id').value = '';
      document.getElementById('t-name').value = '';
      document.getElementById('t-contact').value = '';
      document.getElementById('t-qty').value = '';
      document.getElementById('t-notes').value = '';
      document.getElementById('t-custom-product').value = '';
      document.getElementById('t-custom-size').value = '';

      document.getElementById('btn-submit').textContent = 'üì§ Record Sale';
      document.getElementById('btn-cancel').style.display = 'none';

      // Reset dropdowns
      updateProducts();
    }

    // --- Renderers ---

    function renderDashboard() {
      // Since we only do sales now, stat-in might be irrelevant but we keep it for old data
      const buyTotal = state.transactions.filter(t => t.type === 'buy').reduce((acc, t) => acc + t.qty, 0);
      const sellTotal = state.transactions.filter(t => t.type === 'sell').reduce((acc, t) => acc + t.qty, 0);

      document.getElementById('stat-in').textContent = buyTotal.toLocaleString();
      document.getElementById('stat-out').textContent = sellTotal.toLocaleString();
      document.getElementById('stat-total').textContent = state.transactions.length;

      // Low Stock Check
      checkLowStock();

      // Recent 5
      const tbody = document.getElementById('recent-table-body');
      tbody.innerHTML = state.transactions.slice(0, 5).map(t => `
                <tr>
                    <td>${t.date}</td>
                    <td><span class="badge ${t.type === 'buy' ? 'badge-buy' : 'badge-sell'}">${t.type.toUpperCase()}</span></td>
                    <td>${t.product}</td>
                    <td>${t.qty}</td>
                    <td>${t.name}</td>
                </tr>
            `).join('');

      // Also render catalog manager
      renderCatalogManager();
    }

    function calculateInventory(product, size) {
      // Just sum ins and subtract outs
      let total = 0;
      state.transactions.forEach(t => {
        if (t.product === product && (t.size === size || (!size && !t.size))) {
          if (t.type === 'buy') total += t.qty;
          if (t.type === 'sell') total -= t.qty;
        }
      });
      return total;
    }

    function checkLowStock() {
      const LIMIT = 50; // Threshold
      const alertBox = document.getElementById('lowStockAlert');
      const list = document.getElementById('lowStockList');
      list.innerHTML = '';
      let hasAlerts = false;

      // Iterate Catalog
      Object.entries(state.catalog).forEach(([prod, sizes]) => {
        sizes.forEach(size => {
          const stock = calculateInventory(prod, size);
          if (stock < LIMIT) {
            hasAlerts = true;
            const li = document.createElement('li');
            li.innerHTML = `<b>${prod} (${size})</b> is low! Current Stock: <span style="color:red; font-weight:bold;">${stock}</span>`;
            list.appendChild(li);
          }
        });
      });

      alertBox.style.display = hasAlerts ? 'block' : 'none';

      // Also update stat cards if needed (optional)
      // document.getElementById('stat-stock').textContent = hasAlerts ? "ALERTS ACTIVE" : "OK";
    }

    function renderCatalogManager() {
      const container = document.getElementById('catalog-manager');

      let html = `
          <!-- Bulk Add Section -->
          <div class="bulk-add-area">
             <h4 style="margin:0 0 10px 0;">‚ö° Bulk Add Items</h4>
             <div style="display:flex; gap:10px; margin-bottom:5px;">
                 <select id="bulk-target" style="flex:1;">
                     <option value="NEW_PROD">‚òÖ New Products (One Name Per Line)</option>
                     ${Object.keys(state.catalog).map(k => `<option value="${k}">Add Sizes to "${k}"</option>`).join('')}
                 </select>
                 <button class="btn-primary" onclick="executeBulkAdd()" style="background:#2980b9;">‚ûï Add All</button>
             </div>
             <textarea id="bulk-input" rows="3" placeholder="Enter items here, one per line..."></textarea>
          </div>

          <!-- Export Section -->
          <div style="grid-column: 1 / -1; margin-bottom: 20px; display:flex; gap:10px; align-items:center;">
              <button class="btn-primary" style="background:#27AE60;" onclick="openExportModal()">üì• Download Reports (Categorized)</button>
              <span style="font-size:0.8rem; color:#666;">Select multiple reports like Sales Log, Inventory, or Audit Trail.</span>
          </div>
       `;

      html += Object.entries(state.catalog).map(([prod, sizes]) => `
          <div class="dm-card">
              <div class="dm-header">
                  <span>${prod}</span>
                  <div>
                      <button class="btn-icon" onclick="renameProduct('${prod}')" title="Rename Product">‚úèÔ∏è</button>
                      <button class="btn-icon" onclick="deleteProduct('${prod}')" title="Delete Product" style="color:red;">üóëÔ∏è</button>
                  </div>
              </div>
              <div class="dm-sizes">
                  ${sizes.map(s => `
                      <div class="dm-size-item">
                          <span>${s}</span>
                          <span style="font-size:0.8rem; color:#666;">(Stock: ${calculateInventory(prod, s)})</span>
                          <div>
                              <button class="btn-icon" onclick="renameSize('${prod}', '${s}')" title="Rename Size">‚úèÔ∏è</button>
                              <button class="btn-icon" onclick="deleteSize('${prod}', '${s}')" title="Delete Size" style="color:red;">√ó</button>
                          </div>
                      </div>
                  `).join('')}
              </div>
          </div>
       `).join('');

      container.innerHTML = html;
    }

    // --- Bulk Ops & Export Modal Logic ---

    window.executeBulkAdd = () => {
      const target = document.getElementById('bulk-target').value;
      const text = document.getElementById('bulk-input').value;
      if (!text.trim()) return alert("Please enter some items!");

      const lines = text.split('\n').map(l => l.trim()).filter(l => l);
      let count = 0;

      if (target === 'NEW_PROD') {
        lines.forEach(line => {
          if (!state.catalog[line]) {
            state.catalog[line] = [];
            count++;
          }
        });
      } else {
        // Add sizes to existing product
        if (!state.catalog[target]) return;
        lines.forEach(line => {
          if (!state.catalog[target].includes(line)) {
            state.catalog[target].push(line);
            count++;
          }
        });
      }

      if (count > 0) {
        saveData();
        refreshAll();
        updateProducts(); // Update dropdowns
        document.getElementById('bulk-input').value = '';
        alert(`‚úÖ Added ${count} items successfully!`);
      } else {
        alert('‚ö†Ô∏è No new items added (duplicates?).');
      }
    };

    // Report Logic
    window.openExportModal = () => {
      document.getElementById('exportModal').style.display = 'flex';
    };

    window.closeExportModal = () => {
      document.getElementById('exportModal').style.display = 'none';
    };

    window.downloadSelectedReports = () => {
      const reports = [];
      if (document.getElementById('rep-sales').checked) reports.push('sales');
      if (document.getElementById('rep-in').checked) reports.push('in');
      if (document.getElementById('rep-inv').checked) reports.push('inv');
      if (document.getElementById('rep-audit').checked) reports.push('audit');

      if (reports.length === 0) return alert("Select at least one report!");

      // Mock sequential download (browsers might block multiple popups, but usually allow 1-2)
      // Ideally we zip them, but here we just trigger multiple downloads

      const timestamp = new Date().toISOString().slice(0, 10);

      reports.forEach(type => {
        if (type === 'sales') {
          const data = state.transactions.filter(t => t.type === 'sell');
          exportCSV("Sales_Log_" + timestamp, data, ["Date", "Buyer", "Product", "Size", "Qty", "Notes"]);
        }
        if (type === 'in') {
          const data = state.transactions.filter(t => t.type === 'buy');
          exportCSV("Stock_In_Log_" + timestamp, data, ["Date", "Product", "Size", "Qty"]);
        }
        if (type === 'audit') {
          // Format audit log
          const auditData = state.auditLog.map(l => ({
            Time: l.timestamp, UserTime: l.userTime, Action: l.action, Details: JSON.stringify(l.details).replace(/"/g, '""')
          }));
          exportCSV("Audit_Trail_" + timestamp, auditData, ["Time", "UserTime", "Action", "Details"]);
        }
        if (type === 'inv') {
          // Generate Inventory Report
          const rows = [];
          Object.entries(state.catalog).forEach(([prod, sizes]) => {
            sizes.forEach(size => {
              rows.push({
                Product: prod, Size: size, Stock: calculateInventory(prod, size)
              });
            });
          });
          exportCSV("Inventory_Status_" + timestamp, rows, ["Product", "Size", "Stock"]);
        }
      });

      closeExportModal();
    };

    function exportCSV(filename, data, headers) {
      if (data.length === 0) return; // Skip empty

      // If data is array of objects, extract values based on headers (loosely) or just keys
      // Simple mapper
      const validKeys = headers || Object.keys(data[0]);

      const csvRows = [validKeys.join(",")];

      data.forEach(obj => {
        const row = validKeys.map(k => {
          const val = obj[k] !== undefined ? obj[k] : (obj[k.toLowerCase()] || '');
          return `"${val}"`;
        }).join(",");
        csvRows.push(row);
      });

      const csvContent = "data:text/csv;charset=utf-8," + csvRows.join("\n");
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `${filename}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Existing single export function (kept for table view)
    window.exportReport = () => {
      // ... (existing logic)
      const data = window.currentFilteredData || state.transactions;
      // Re-use new exportCSV helper
      exportCSV(`UHD_Filtered_Report_${Date.now()}`, data, ["date", "type", "name", "contact", "product", "size", "qty", "notes"]);
    };

    // --- Data Management Logic ---

    window.renameProduct = (oldName) => {
      const newName = prompt("Rename Product:", oldName);
      if (newName && newName !== oldName) {
        // Move sizes to new key
        state.catalog[newName] = state.catalog[oldName];
        delete state.catalog[oldName];

        // Update history? (Optional, but good for consistency)
        state.transactions.forEach(t => {
          if (t.product === oldName) t.product = newName;
        });

        saveData();
        refreshAll();
      }
    };

    window.deleteProduct = (prodName) => {
      if (confirm(`Delete "${prodName}" and ALL its sizes? This does not delete transaction history.`)) {
        delete state.catalog[prodName];
        saveData();
        refreshAll();
      }
    };

    window.renameSize = (prod, oldSize) => {
      const newSize = prompt("Rename Size:", oldSize);
      if (newSize && newSize !== oldSize) {
        const sizes = state.catalog[prod];
        const idx = sizes.indexOf(oldSize);
        if (idx !== -1) {
          sizes[idx] = newSize;

          // Update history
          state.transactions.forEach(t => {
            if (t.product === prod && t.size === oldSize) t.size = newSize;
          });

          saveData();
          refreshAll();
        }
      }
    };

    window.deleteSize = (prod, size) => {
      if (confirm(`Delete size "${size}"?`)) {
        state.catalog[prod] = state.catalog[prod].filter(s => s !== size);
        saveData();
        refreshAll();
      }
    };

    window.editTx = (id) => {
      const tx = state.transactions.find(t => t.id === id);
      if (!tx) return;

      // Switch to entry (form) tab
      navigate('entry');

      // Populate Form
      document.getElementById('t-id').value = tx.id;
      document.getElementById('t-date').value = tx.date;
      document.getElementById('t-name').value = tx.name;
      fillContact(); // auto-fill contact
      document.getElementById('t-qty').value = tx.qty;
      document.getElementById('t-notes').value = tx.notes || '';

      // Setup Product/Size
      // We need to wait for product update to select size
      updateProducts();
      document.getElementById('t-product').value = tx.product || tx.material || '';
      handleProductChange(); // Trigger size load

      document.getElementById('t-size').value = tx.size || '';

      // Change UI to Edit Mode
      document.getElementById('btn-submit').textContent = 'üíæ Update Sale';
      document.getElementById('btn-cancel').style.display = 'inline-block';
      document.getElementById('tradeForm').scrollIntoView({ behavior: 'smooth' });
    };

    function renderTable() {
      // Get Filter Values
      const fStart = document.getElementById('f-date-start').value;
      const fBuyer = document.getElementById('f-buyer').value.toLowerCase();
      const fType = document.getElementById('f-type').value;
      const fProd = document.getElementById('f-product').value.toLowerCase();
      const fSize = document.getElementById('f-size').value.toLowerCase();

      const filtered = state.transactions.filter(t => {
        // Date Logic (Simple >= Start)
        const dateMatch = !fStart || t.date >= fStart;

        // Type Logic
        const typeMatch = fType === 'all' || t.type === fType;

        // String Matches
        const buyerMatch = !fBuyer || t.name.toLowerCase().includes(fBuyer);
        const prodMatch = !fProd || (t.product && t.product.toLowerCase().includes(fProd));
        const sizeMatch = !fSize || (t.size && t.size.toLowerCase().includes(fSize));

        return dateMatch && typeMatch && buyerMatch && prodMatch && sizeMatch;
      });

      const tbody = document.getElementById('full-table-body');
      tbody.innerHTML = filtered.map(t => `
                <tr>
                    <td>${t.date}</td>
                    <td>${t.name}</td>
                    <td>${t.contact}</td>
                    <td><span class="badge ${t.type === 'buy' ? 'badge-buy' : 'badge-sell'}">${t.type.toUpperCase()}</span></td>
                    <td>${t.product}</td>
                    <td>${t.size || '-'}</td>
                    <td>${t.qty}</td>
                    <td>${t.notes}</td>
                    <td>
                        <button onclick="editTx(${t.id})" style="margin-right:5px; border:none; background:none; cursor:pointer;" title="Edit">‚úèÔ∏è</button>
                        <button onclick="deleteTx(${t.id})" style="color:red; border:none; background:none; cursor:pointer;" title="Delete">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');

      // Store current filtered view for export
      window.currentFilteredData = filtered;
    }

    window.exportReport = () => {
      const data = window.currentFilteredData || state.transactions;
      if (data.length === 0) return alert("No data to export!");

      const headers = ["Date", "Type", "Buyer", "Contact", "Product", "Size", "Qty", "Notes"];
      const rows = data.map(t => {
        return `"${t.date}","${t.type}","${t.name}","${t.contact}","${t.product}","${t.size || ''}","${t.qty}","${t.notes.replace(/"/g, '""')}"`;
      });

      const csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.join("\n");
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `UHD_Report_${Date.now()}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    function deleteTx(id) {
      if (confirm('Delete this transaction?')) {
        const tx = state.transactions.find(t => t.id === id);
        if (tx) logAudit('DELETE', tx); // Audit Log
        state.transactions = state.transactions.filter(t => t.id !== id);
        saveData();
        refreshAll();
      }
    };

    function renderDealers() {
      const search = document.getElementById('dealer-search').value.toLowerCase();
      const grid = document.getElementById('dealer-grid');

      const entries = Object.entries(state.traders).filter(([name, contact]) => {
        return name.toLowerCase().includes(search) || contact.includes(search);
      });

      if (entries.length === 0) {
        grid.innerHTML = '<p style="color:#aaa; col-span:3;">No dealers found.</p>';
        return;
      }

      grid.innerHTML = entries.map(([name, contact]) => `
                <div class="dealer-card">
                    <h4>üë§ ${name}</h4>
                    <p>üìû ${contact || 'No Contact'}</p>
                    <p style="margin-top:5px; font-size:0.8rem;">
                        <a href="#" onclick="startTrade('${name}')">Make Sale ‚û°Ô∏è</a>
                    </p>
                </div>
            `).join('');
    }

    window.startTrade = (name) => {
      navigate('trade');
      document.getElementById('t-name').value = name;
      fillContact();
    };

  </script>
  </script>

  <!-- Export Modal -->
  <div id="exportModal" class="modal-overlay">
    <div class="modal-content">
      <h3 style="margin-top:0;">üì• Download Reports</h3>
      <p style="color:#666; font-size:0.9rem;">Select the reports you want to generate:</p>

      <div class="modal-checkbox-list">
        <label class="modal-checkbox-item">
          <input type="checkbox" id="rep-sales" checked> üìã Full Sales Log
        </label>
        <label class="modal-checkbox-item">
          <input type="checkbox" id="rep-in"> üì¶ Stock In Log
        </label>
        <label class="modal-checkbox-item">
          <input type="checkbox" id="rep-inv"> üìä Inventory Status (Current Stock)
        </label>
        <label class="modal-checkbox-item">
          <input type="checkbox" id="rep-audit" checked> üîí Full Audit Log (Security)
        </label>
      </div>

      <div style="display:flex; gap:10px; justify-content:flex-end;">
        <button onclick="closeExportModal()"
          style="border:none; background:#eee; padding:10px 15px; border-radius:4px; cursor:pointer;">Cancel</button>
        <button onclick="downloadSelectedReports()" class="btn-primary">Download Selected</button>
      </div>
    </div>
  </div>
  <!-- Login Overlay -->
  <div id="login-overlay">
    <!-- Normal Login View -->
    <div id="login-view" class="login-box">
      <h2>üîê Security Access</h2>
      <p style="color:#666; margin-bottom:20px;">Uthaya Hollow Blocks</p>

      <input type="text" id="login-user" class="login-input" placeholder="Username" autocomplete="off">
      <input type="password" id="login-pass" class="login-input" placeholder="Password">

      <button onclick="auth.login()" class="btn-login">Unlock System</button>
      <p id="login-error" class="login-error">üö´ Access Denied</p>

      <div style="margin-top:20px; display:flex; justify-content:space-between; align-items:center;">
        <a href="#" onclick="auth.toggleSignupView(true)">Create Request</a>
        <a href="#" onclick="auth.toggleResetView(true)" style="color:var(--grey);">Forgot Password?</a>
      </div>
    </div>

    <!-- Signup View -->
    <div id="signup-view" class="login-box">
      <h2>‚ú® Request Access</h2>
      <p style="color:#666; margin-bottom:20px; font-size:0.9rem;">Fill in details to request account approval.</p>

      <input type="text" id="signup-user" class="login-input" placeholder="Desired Username" autocomplete="off">
      <input type="password" id="signup-pass" class="login-input" placeholder="Desired Password">

      <button onclick="auth.handleSignup()" class="btn-login" style="background:var(--primary);">üöÄ Send
        Request</button>

      <p style="margin-top:20px;">
        <a href="#" onclick="auth.toggleSignupView(false)" style="color:var(--grey);">Back to Login</a>
      </p>
    </div>

    <!-- Forgot Password View -->
    <div id="reset-view" class="login-box" style="display:none;">
      <h3>üîë Request Reset</h3>
      <p style="color:#666; margin-bottom:20px; font-size:0.9rem;">Enter your Username. The Master will receive your
        request.</p>

      <input type="text" id="reset-user" class="login-input" placeholder="Your Username" autocomplete="off">

      <button onclick="auth.requestReset()" class="btn-login" style="background:var(--dark);">üöÄ Send Request</button>

      <p style="margin-top:15px; font-size:0.9rem;">
        <a href="#" onclick="auth.toggleResetView(false)" style="color:var(--grey);">Back to Login</a>
      </p>
    </div>
  </div>

  <!-- User Management Modal -->
  <div id="userModal" class="modal-overlay">
    <div class="modal-content">
      <h3 style="margin-top:0;">üë• User Management</h3>
      <p style="color:#666; font-size:0.9rem;">Only Master can manage users.</p>

      <div style="border-bottom:1px solid #eee; padding-bottom:15px; margin-bottom:15px;">
        <h4 style="margin:0 0 10px 0;">Add New User</h4>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
          <input type="text" id="new-u-name" placeholder="Username"
            style="padding:10px; border:1px solid #ccc; border-radius:4px;">
          <input type="text" id="new-u-pass" placeholder="Password"
            style="padding:10px; border:1px solid #ccc; border-radius:4px;">
        </div>
        <button onclick="auth.addUser()" class="btn-primary" style="width:100%; padding:10px;">ADD USER</button>
      </div>

      <div class="user-table-container" style="overflow-x:auto;">
        <table class="data-table" style="width:100%; min-width:400px; table-layout: fixed;">
          <thead>
            <tr>
              <th style="width: 40%">Authors</th>
              <th style="width: 30%">Designation</th>
              <th style="width: 30%">Action</th>
            </tr>
          </thead>
          <tbody id="user-list-body"></tbody>
        </table>
      </div>

      <div style="margin-top:20px; text-align:right;">
        <button onclick="auth.closeUserModal()"
          style="background:#eee; padding:8px 16px; border:none; border-radius:4px; cursor:pointer;">Close</button>
      </div>
    </div>
  </div>

  <!-- User Profile & Permissions Modal -->
  <div id="userProfileModal" class="modal-overlay">
    <div class="modal-content" style="max-width:500px;">
      <h3 id="profile-title">Edit User Profile</h3>

      <div style="margin-bottom:15px;">
        <label style="display:block; font-size:0.8rem; margin-bottom:5px;">Username</label>
        <input type="text" id="prof-user" readonly
          style="width:100%; padding:10px; background:#f5f5f5; border:1px solid #ddd;">
      </div>

      <div style="margin-bottom:15px;">
        <label style="display:block; font-size:0.8rem; margin-bottom:5px;">Password</label>
        <input type="text" id="prof-pass" style="width:100%; padding:10px; border:1px solid #ddd;">
      </div>

      <div style="margin-bottom:20px;">
        <label style="display:block; font-size:0.8rem; margin-bottom:5px;">Assigned Role</label>
        <select id="prof-role" onclick="auth.applyRoleDefaults()"
          style="width:100%; padding:10px; border:1px solid #ddd;">
          <option value="Owner">Owner</option>
          <option value="Worker">Worker</option>
          <option value="Guest">Guest</option>
        </select>
      </div>

      <div style="border-top:1px solid #eee; padding-top:15px;">
        <h4 style="margin:0 0 10px 0; color:var(--primary);">Access Permissions</h4>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <label style="cursor:pointer; font-size:0.9rem; display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="p-add" style="width:18px; height:18px;"> <span>Add Transaction</span>
          </label>
          <label style="cursor:pointer; font-size:0.9rem; display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="p-edit" style="width:18px; height:18px;"> <span>Edit Transaction</span>
          </label>
          <label style="cursor:pointer; font-size:0.9rem; display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="p-delete" style="width:18px; height:18px;"> <span>Delete Transaction</span>
          </label>
          <label style="cursor:pointer; font-size:0.9rem; display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="p-reports" style="width:18px; height:18px;"> <span>View Reports</span>
          </label>
          <label style="cursor:pointer; font-size:0.9rem; display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="p-limits" style="width:18px; height:18px;"> <span>Stock Limits</span>
          </label>
        </div>
      </div>

      <div style="margin-top:25px; text-align:right; display:flex; gap:10px; justify-content:flex-end;">
        <button onclick="document.getElementById('userProfileModal').style.display='none'"
          style="padding:8px 16px; background:#eee; border:none; border-radius:4px; cursor:pointer;">Cancel</button>
        <button onclick="auth.saveUserProfile()" class="btn-primary" style="padding:8px 20px;">Save Changes</button>
      </div>
    </div>
  </div>
</body>

</html>